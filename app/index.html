<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Prediction API</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <!-- Include Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .tab-container {
            overflow: hidden;
            border-bottom: 1px solid #ccc;
        }
        .tab-button {
            background-color: #ddd;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
        }
        .tab-button:hover {
            background-color: #bbb;
        }
        .tab-button.active {
            background-color: #ccc;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            background-color: white;
        }
        .tab-content.active {
            display: block;
        }
        #map-container {
            height: 500px;
        }
        .legend {
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .legend i {
            width: 10px;
            height: 10px;
            display: inline-block;
            margin-right: 5px;
        }
        .leaflet-control-custom button {
            width: 100%;
            height: 100%;
            border: none;
            background-color: #fff;
            cursor: pointer;
            font-size: 14px;
        }
        .leaflet-control-custom button:hover {
            background-color: #f0f0f0;
        }
        #decision-tree-container {
            text-align: center;
            margin-top: 20px;
        }
        #decision-tree-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .route-label {
            background: none;
            border: none;
            box-shadow: none;
            color: black;
            font-size: 8px;
            text-align: center;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h1>Bus Prediction API</h1>
    <div class="tab-container">
        <button class="tab-button active" onclick="openTab(event, 'home')">Home</button>
        <button class="tab-button" onclick="openTab(event, 'docs')">Docs</button>
        <button class="tab-button" onclick="openTab(event, 'map')">Map</button>
        <button class="tab-button" onclick="openTab(event, 'dashboard')">Data Dashboard</button>
    </div>

    <div id="home" class="tab-content active">
        <h2>Home</h2>
        <p>Welcome to the Bus Prediction API. Use the tabs above to explore documentation, view a real-time map, or check the data dashboard.</p>
        <p>Try fetching predictions at <a href="/get_predictions">/get_predictions</a> or vehicle positions at <a href="/fetch_vehicle_positions">/fetch_vehicle_positions</a>.</p>
    </div>

    <div id="docs" class="tab-content">
        <h2>API Documentation</h2>
        <p>Explore the API documentation using the following tools:</p>
        <ul>
            <li><a href="/docs" target="_blank">Swagger UI</a> - Interactive API testing and documentation</li>
            <li><a href="/redoc" target="_blank">ReDoc</a> - Clean, readable API documentation</li>
        </ul>
    </div>

    <div id="map" class="tab-content">
        <h2>Real-Time Map</h2>
        <p>This map uses a Decision Tree Classifier to predict the on-time status of a bus.</p>
        <div id="map-container"></div>
        <p>The number inside each circle represents the bus's route ID.</p>
    </div>

    <div id="dashboard" class="tab-content">
        <h2>Data Dashboard</h2>
        <p>Below is the Decision Tree model used for predictions:</p>
        <div id="decision-tree-container">
            <p><strong>Decision Tree model</strong></p>
            <img 
                id="decision-tree-img" 
                src="/assets/tree.png" 
                alt="Decision Tree Visualization" 
                onload="console.log('Decision Tree image loaded successfully from /assets/tree.png');" 
                onerror="handleImageError(this);"
            >
            <p id="decision-tree-error" style="display:none; color:red;">Failed to load Decision Tree image from /assets/tree.png. Check the file path and server setup.</p>
        </div>
        <p>Coming soon! Use <a href="/fetch_vehicle_positions">vehicle positions</a> and <a href="/fetch_trip_updates">trip updates</a> for analytics.</p>
    </div>

    <script>
        var mapInitialized = false;
        var map;
        var busMarkers;
        var userMarker;

        var MyLocationControl = L.Control.extend({
            options: {
                position: 'topleft'
            },
            onAdd: function(map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                container.innerHTML = '<button onclick="locateUser()">Use my location</button>';
                container.style.backgroundColor = 'white';
                container.style.width = '150px';
                container.style.height = '30px';
                return container;
            }
        });

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        var lat = position.coords.latitude;
                        var lon = position.coords.longitude;
                        map.setView([lat, lon], 15);
                        if (userMarker) {
                            map.removeLayer(userMarker);
                        }
                        userMarker = L.marker([lat, lon])
                            .addTo(map)
                            .bindPopup("You are here")
                            .openPopup();
                    },
                    function(error) {
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                alert("Location access denied.");
                                break;
                            case error.POSITION_UNAVAILABLE:
                                alert("Location information unavailable.");
                                break;
                            case error.TIMEOUT:
                                alert("Location request timed out.");
                                break;
                            default:
                                alert("An unknown error occurred.");
                                break;
                        }
                    }
                );
            } else {
                alert("Geolocation is not supported by your browser.");
            }
        }

        function handleImageError(img) {
            console.error('Error loading Decision Tree image from: ' + img.src);
            img.style.display = 'none';
            document.getElementById('decision-tree-error').style.display = 'block';
        }

        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");

            if (tabName === 'map' && !mapInitialized) {
                map = L.map('map-container').setView([43.8975, -78.8658], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
                busMarkers = L.layerGroup().addTo(map);

                // Add "Use my location" button
                map.addControl(new MyLocationControl());

                // Add legend
                var legend = L.control({position: 'bottomright'});
                legend.onAdd = function (map) {
                    var div = L.DomUtil.create('div', 'legend');
                    div.innerHTML += '<i style="background: green"></i> On Time<br>';
                    div.innerHTML += '<i style="background: blue"></i> Early<br>';
                    div.innerHTML += '<i style="background: red"></i> Late<br>';
                    return div;
                };
                legend.addTo(map);

                mapInitialized = true;
                fetchAndUpdateMap();
                setInterval(fetchAndUpdateMap, 5000);
            }

            // Reset decision tree image visibility when opening dashboard
            if (tabName === 'dashboard') {
                var img = document.getElementById('decision-tree-img');
                var errorMsg = document.getElementById('decision-tree-error');
                img.style.display = 'block';
                errorMsg.style.display = 'none';
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'on-time': return 'green';
                case 'early': return 'blue';
                case 'late': return 'red';
                default: return 'gray';
            }
        }

        function fetchAndUpdateMap() {
            fetch('/get_predictions')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    busMarkers.clearLayers();
                    data.bus_predictions.forEach(bus => {
                        var color = getStatusColor(bus.predicted_status);
                        var marker = L.circleMarker([bus.current_lat, bus.current_lon], {
                            color: color,
                            radius: 10
                        }).addTo(busMarkers);
                        
                        marker.bindTooltip(bus.route_id, {
                            permanent: true,
                            direction: 'center',
                            className: 'route-label'
                        });
                        
                        marker.bindPopup(`Bus ID: ${bus.bus_id}<br>Route ID: ${bus.route_id}<br>Predicted Status: ${bus.predicted_status}`);
                    });
                })
                .catch(error => console.error('Error fetching predictions:', error));
        }
    </script>
</body>
</html>